<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>serve_app</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f1117;
    color: #e1e4e8;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* â”€â”€ Sidebar â”€â”€ */
  #sidebar {
    width: 220px;
    flex-shrink: 0;
    background: #161b22;
    border-right: 1px solid #21262d;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  #sidebar-header {
    padding: 18px 16px 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #8b949e;
    border-bottom: 1px solid #21262d;
  }
  .project-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #21262d;
    transition: background 0.15s;
    text-decoration: none;
    color: inherit;
  }
  .project-item:hover { background: #1c2128; }
  .project-item.active { background: #1f2d3d; border-left: 3px solid #58a6ff; padding-left: 13px; }
  .project-item-info { flex: 1; min-width: 0; }
  .project-item-name {
    font-size: 13px;
    font-weight: 600;
    color: #c9d1d9;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .project-item-meta {
    font-size: 11px;
    color: #6e7681;
    margin-top: 2px;
  }
  .project-item-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot-ready    { background: #3fb950; }
  .dot-building { background: #f0c040; }
  .dot-failed   { background: #f85149; }
  .dot-unknown  { background: #484f58; }

  /* â”€â”€ Main panel â”€â”€ */
  #main {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
    min-width: 0;
  }

  #empty-state {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6e7681;
    font-size: 15px;
    text-align: center;
  }

  /* â”€â”€ Project detail â”€â”€ */
  #detail { display: none; }
  #detail-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 28px;
  }
  #detail-title {
    font-size: 22px;
    font-weight: 700;
    color: #e1e4e8;
  }
  #detail-subtitle {
    font-size: 13px;
    color: #8b949e;
    margin-top: 2px;
  }

  /* Status badge */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
  }
  .badge-ready    { background: #0f2d1a; color: #3fb950; }
  .badge-building { background: #2d2200; color: #f0c040; }
  .badge-failed   { background: #2d0000; color: #f85149; }
  .badge-unknown  { background: #21262d; color: #8b949e; }

  /* Spinner for building */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner-sm {
    width: 10px;
    height: 10px;
    border: 2px solid #4a3900;
    border-top-color: #f0c040;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }

  /* Downloads section */
  #downloads-section {
    margin-bottom: 24px;
  }
  .artifacts-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .artifact-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .btn-artifact {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #238636;
    color: #fff;
    text-decoration: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .btn-artifact:hover { background: #2ea043; }
  .btn-artifact-debug { background: #1f6feb; }
  .btn-artifact-debug:hover { background: #388bfd; }
  .artifact-size { font-size: 12px; opacity: 0.75; font-weight: 400; }
  .artifact-time { font-size: 11px; color: #6e7681; padding-left: 2px; }
  .badge-local {
    font-size: 10px;
    font-weight: 700;
    background: #f0c040;
    color: #1a1200;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.04em;
  }
  .badge-stable {
    font-size: 10px;
    font-weight: 700;
    background: rgba(255,255,255,0.18);
    color: #fff;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.04em;
  }
  .badge-latest {
    font-size: 10px;
    font-weight: 700;
    background: #e06c00;
    color: #fff;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.04em;
  }

  /* Build button */
  #btn-build {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: 1px solid #30363d;
    color: #c9d1d9;
    padding: 9px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }
  #btn-build:hover:not(:disabled) { background: #21262d; border-color: #8b949e; }
  #btn-build:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Info grid */
  .info-grid {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 8px 16px;
    font-size: 13px;
    background: #161b22;
    border: 1px solid #21262d;
    border-radius: 10px;
    padding: 18px 20px;
    margin-bottom: 24px;
  }
  .info-grid .label {
    font-weight: 600;
    color: #8b949e;
  }
  .info-grid .value {
    color: #c9d1d9;
    word-break: break-word;
  }
  .info-grid .mono {
    font-family: 'SFMono-Regular', Consolas, monospace;
    color: #58a6ff;
  }

  /* Build log */
  .log-block {
    margin-bottom: 24px;
    border: 1px solid #21262d;
    border-radius: 10px;
    overflow: hidden;
  }
  .log-block.error { border-color: rgba(248,81,73,0.35); }

  .log-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 14px;
    background: #161b22;
    cursor: pointer;
    user-select: none;
  }
  .log-block.error .log-header { background: #1a0a0a; }

  .log-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
  }
  .log-block.error .log-header-left { color: #f85149; }
  .log-block:not(.error) .log-header-left { color: #8b949e; }

  .log-chevron {
    font-size: 10px;
    color: #6e7681;
    transition: transform 0.15s;
  }
  .log-chevron.open { transform: rotate(180deg); }

  .log-body {
    background: #0d1117;
    padding: 12px 14px;
    font-family: 'SFMono-Regular', Consolas, monospace;
    font-size: 11.5px;
    line-height: 1.6;
    color: #c9d1d9;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 380px;
    overflow-y: auto;
    border-top: 1px solid #21262d;
  }
  .log-block.error .log-body { color: #f0a0a0; }

  /* Build history */
  .section-title {
    font-size: 14px;
    font-weight: 600;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 12px;
  }
  .history-list {
    background: #161b22;
    border: 1px solid #21262d;
    border-radius: 10px;
    overflow: hidden;
  }
  .history-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    border-bottom: 1px solid #21262d;
    font-size: 12px;
  }
  .history-item:last-child { border-bottom: none; }
  .history-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .history-commit {
    font-family: 'SFMono-Regular', Consolas, monospace;
    color: #58a6ff;
    flex-shrink: 0;
    width: 56px;
  }
  .history-msg {
    flex: 1;
    color: #c9d1d9;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .history-branch {
    color: #8b949e;
    flex-shrink: 0;
    font-size: 11px;
  }
  .history-time {
    color: #6e7681;
    flex-shrink: 0;
    width: 56px;
    text-align: right;
  }

  /* No projects empty state */
  .empty-sidebar {
    padding: 20px 16px;
    font-size: 12px;
    color: #484f58;
    line-height: 1.6;
  }

  /* â”€â”€ Mobile: master-detail navigation â”€â”€ */
  #btn-back {
    display: none;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    color: #58a6ff;
    font-size: 15px;
    cursor: pointer;
    padding: 0;
    margin-bottom: 20px;
  }

  @media (max-width: 640px) {
    body { overflow: auto; }

    #sidebar {
      width: 100%;
      height: 100vh;
      border-right: none;
      border-bottom: 1px solid #21262d;
    }

    #main {
      display: none;
      width: 100%;
      padding: 20px 16px;
      min-height: 100vh;
    }

    /* list view: sidebar visible, detail hidden */
    body.mobile-list #sidebar  { display: flex; }
    body.mobile-list #main     { display: none; }

    /* detail view: sidebar hidden, detail visible */
    body.mobile-detail #sidebar { display: none; }
    body.mobile-detail #main    { display: block; }

    #btn-back { display: flex; }

    #detail-header { flex-wrap: wrap; gap: 10px; }
    .artifacts-row { flex-direction: column; }
    .btn-artifact { justify-content: center; }

    .history-branch { display: none; }
  }
</style>
</head>
<body>

<nav id="sidebar">
  <div id="sidebar-header">Projects</div>
  <div id="project-list">
    <div class="empty-sidebar">No projects registered yet.</div>
  </div>
</nav>

<main id="main">
  <button id="btn-back" onclick="goBack()">&#8592; Projects</button>
  <div id="empty-state">
    <div>
      <div style="font-size:32px;margin-bottom:12px;">ðŸ“¦</div>
      <div>Select a project from the sidebar</div>
    </div>
  </div>
  <div id="detail">
    <div id="detail-header">
      <div>
        <div id="detail-title"></div>
        <div id="detail-subtitle"></div>
      </div>
      <div id="status-badge" class="status-badge badge-unknown"></div>
      <button id="btn-build" onclick="triggerBuild()">â–¶ Build</button>
    </div>
    <div id="info-section" class="info-grid"></div>
    <div id="downloads-section"></div>
    <div id="log-section" style="display:none">
      <div id="log-block" class="log-block error">
        <div class="log-header" onclick="toggleLog()">
          <div class="log-header-left">
            <span id="log-label">Build Output</span>
          </div>
          <span id="log-chevron" class="log-chevron open">â–¼</span>
        </div>
        <div id="log-body" class="log-body"></div>
      </div>
    </div>
    <div class="section-title">Build History</div>
    <div id="history-section" class="history-list" style="display:none"></div>
  </div>
</main>

<script>
// â”€â”€ State â”€â”€
let projects = [];
let selectedId = null;
let statusData = null;
let historyData = [];

// â”€â”€ Utilities â”€â”€
function esc(s) {
  const d = document.createElement('div');
  d.textContent = String(s || '');
  return d.innerHTML;
}

function relativeTime(ts) {
  if (!ts) return '';
  const diff = Date.now() - new Date(ts).getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  return new Date(ts).toLocaleDateString();
}

function formatTime(ts) {
  if (!ts) return '-';
  return new Date(ts).toLocaleString();
}

function formatSize(bytes) {
  if (!bytes || bytes === 0) return '';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function dotClass(status) {
  return { ready: 'dot-ready', building: 'dot-building', failed: 'dot-failed' }[status] || 'dot-unknown';
}

// â”€â”€ Sidebar rendering â”€â”€
function renderSidebar() {
  const listEl = document.getElementById('project-list');
  if (!projects.length) {
    listEl.innerHTML = '<div class="empty-sidebar">No projects registered yet.</div>';
    return;
  }
  listEl.innerHTML = projects.map(p => {
    const active = p.id === selectedId ? ' active' : '';
    const dot = dotClass(p.status);
    const time = relativeTime(p.lastBuildTime);
    return `<a class="project-item${active}" href="#${esc(p.id)}" onclick="selectProject('${esc(p.id)}');return false;">
      <div class="project-item-info">
        <div class="project-item-name">${esc(p.name)}</div>
        <div class="project-item-meta">${time || 'no builds'}</div>
      </div>
      <div class="project-item-dot ${dot}"></div>
    </a>`;
  }).join('');
}

// â”€â”€ Detail panel rendering â”€â”€
function renderDetail() {
  if (!selectedId) {
    document.getElementById('empty-state').style.display = 'flex';
    document.getElementById('detail').style.display = 'none';
    return;
  }

  const proj = projects.find(p => p.id === selectedId);
  if (!proj) return;

  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('detail').style.display = 'block';

  document.getElementById('detail-title').textContent = proj.name;

  const data = statusData;
  const status = data ? data.status : 'unknown';

  // Status badge
  const badgeEl = document.getElementById('status-badge');
  const badgeMap = {
    ready:    ['badge-ready',    '<span class="dot-ready" style="width:8px;height:8px;border-radius:50%;background:#3fb950;display:inline-block"></span> Ready'],
    building: ['badge-building', '<span class="spinner-sm"></span> Buildingâ€¦'],
    failed:   ['badge-failed',   '<span style="color:#f85149">âœ•</span> Failed'],
    unknown:  ['badge-unknown',  'â€” Unknown'],
  };
  const [cls, html] = badgeMap[status] || badgeMap.unknown;
  badgeEl.className = 'status-badge ' + cls;
  badgeEl.innerHTML = html;

  // Build button: disabled while building
  const buildBtn = document.getElementById('btn-build');
  buildBtn.disabled = (status === 'building');
  buildBtn.innerHTML = status === 'building' ? '<span class="spinner-sm"></span> Buildingâ€¦' : 'â–¶ Build';

  // Detail subtitle: branch@commit
  if (data && data.branch && data.commit) {
    document.getElementById('detail-subtitle').textContent = `${data.branch} @ ${data.commit}`;
  } else {
    document.getElementById('detail-subtitle').textContent = '';
  }

  // Info grid
  let info = '';
  if (data) {
    if (data.branch)    info += `<span class="label">Branch</span><span class="value">${esc(data.branch)}</span>`;
    if (data.commit)    info += `<span class="label">Commit</span><span class="value mono">${esc(data.commit)}</span>`;
    if (data.message)   info += `<span class="label">Message</span><span class="value">${esc(data.message)}</span>`;
    if (data.timestamp) info += `<span class="label">Built</span><span class="value">${formatTime(data.timestamp)}</span>`;
  }
  const infoEl = document.getElementById('info-section');
  if (info) {
    infoEl.innerHTML = info;
    infoEl.style.display = 'grid';
  } else {
    infoEl.style.display = 'none';
  }

  // Log panel: always show, style and expand based on status
  const logSection = document.getElementById('log-section');
  const logBlock   = document.getElementById('log-block');
  const logLabel   = document.getElementById('log-label');
  const logChevron = document.getElementById('log-chevron');
  const logBody    = document.getElementById('log-body');
  logSection.style.display = 'block';
  if (status === 'failed') {
    logBlock.className = 'log-block error';
    logBody.style.display = 'block';
    logChevron.className = 'log-chevron open';
  } else if (status === 'building') {
    logBlock.className = 'log-block';
    logBody.style.display = 'block';
    logChevron.className = 'log-chevron open';
  } else {
    // ready / unknown: collapsed by default
    logBlock.className = 'log-block';
    logBody.style.display = 'none';
    logChevron.className = 'log-chevron';
  }

  // History
  renderHistory();
}

function renderHistory() {
  const el = document.getElementById('history-section');
  if (!historyData || historyData.length === 0) {
    el.style.display = 'none';
    return;
  }
  el.style.display = 'block';
  el.innerHTML = historyData.map(item => {
    const dot = dotClass(item.status);
    return `<div class="history-item">
      <span class="history-dot ${dot}"></span>
      <span class="history-commit">${esc(item.commit || '')}</span>
      <span class="history-msg">${esc(item.message || '')}</span>
      <span class="history-branch">${esc(item.branch || '')}</span>
      <span class="history-time">${relativeTime(item.timestamp)}</span>
    </div>`;
  }).join('');
}

// â”€â”€ Mobile navigation â”€â”€
function isMobile() { return window.innerWidth <= 640; }

function goBack() {
  document.body.className = 'mobile-list';
  window.location.hash = '';
}

function setMobileView(hasSelection) {
  if (isMobile()) {
    document.body.className = hasSelection ? 'mobile-detail' : 'mobile-list';
  } else {
    document.body.className = '';
  }
}

// â”€â”€ Project selection â”€â”€
function selectProject(id) {
  stopLogLive();
  selectedId = id;
  statusData = null;
  historyData = [];
  document.getElementById('log-body').textContent = '';
  window.location.hash = id;
  setMobileView(true);
  renderSidebar();
  renderDetail();
  fetchStatus();
  fetchHistory();
  fetchLog();
  fetchArtifacts();
}

// â”€â”€ Polling â”€â”€
async function fetchProjects() {
  try {
    const res = await fetch('projects.json?t=' + Date.now());
    if (!res.ok) return;
    const data = await res.json();
    // Sort by lastBuildTime descending, unknown last
    data.sort((a, b) => {
      if (!a.lastBuildTime && !b.lastBuildTime) return 0;
      if (!a.lastBuildTime) return 1;
      if (!b.lastBuildTime) return -1;
      return new Date(b.lastBuildTime) - new Date(a.lastBuildTime);
    });
    projects = data;

    // Auto-select first project on initial load
    if (!selectedId && projects.length > 0) {
      const hashId = window.location.hash.slice(1);
      // On mobile, don't auto-select â€” show the list first
      if (isMobile() && !hashId) {
        setMobileView(false);
        renderSidebar();
      } else {
        const target = projects.find(p => p.id === hashId) || projects[0];
        selectProject(target.id);
      }
    } else {
      renderSidebar();
    }
  } catch (e) {}
}

async function fetchStatus() {
  if (!selectedId) return;
  try {
    const res = await fetch(`${selectedId}/build-status.json?t=` + Date.now());
    if (!res.ok) return;
    const prev = statusData ? statusData.status : null;
    statusData = await res.json();
    renderDetail();
    const cur = statusData.status;
    if (cur === 'building') {
      fetchLog();
      startLogLive();
    } else {
      stopLogLive();
      if (cur !== prev) fetchLog(); // refresh once on status change
    }
  } catch (e) {}
}

async function fetchHistory() {
  if (!selectedId) return;
  try {
    const res = await fetch(`${selectedId}/build-history.json?t=` + Date.now());
    if (!res.ok) return;
    historyData = await res.json();
    renderHistory();
  } catch (e) {}
}

async function fetchLog() {
  if (!selectedId) return;
  try {
    const res = await fetch(`${selectedId}/build.log?t=` + Date.now());
    if (!res.ok) return;
    const text = await res.text();
    const body = document.getElementById('log-body');
    if (body.style.display === 'none') return; // collapsed â€” don't update
    const atBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 40;
    body.textContent = text;
    if (atBottom) body.scrollTop = body.scrollHeight;
  } catch (e) {}
}

let logLiveInterval = null;

function startLogLive() {
  if (logLiveInterval) return;
  logLiveInterval = setInterval(fetchLog, 2000);
}

function stopLogLive() {
  if (logLiveInterval) { clearInterval(logLiveInterval); logLiveInterval = null; }
}

// â”€â”€ Artifacts â”€â”€
function renderArtifacts(artifacts) {
  const section = document.getElementById('downloads-section');
  const proj = projects.find(p => p.id === selectedId);
  const data = statusData;

  let items = [];

  // Always show the serve_app-built (Stable) download when status is ready
  const artifactFile = proj && (proj.artifactFile || proj.apkFile);
  const artifactSize = data && (data.artifactSize ?? data.apkSize);
  if (artifactFile && data && data.status === 'ready') {
    const size = artifactSize ? ` <span class="artifact-size">${formatSize(artifactSize)}</span>` : '';
    items.push(
      `<div class="artifact-item">` +
      `<a class="btn-artifact" href="${esc(selectedId)}/${esc(artifactFile)}">â¬‡ Download${size} <span class="badge-stable">Stable</span></a>` +
      `</div>`
    );
  }

  // Additionally show local builds from watchArtifacts (Latest)
  // - same file as apkFile (e.g. Debug that serve_app also builds): only if newer=true
  // - different file (e.g. Release that serve_app never builds): show whenever available
  if (artifacts && artifacts.length > 0) {
    for (const a of artifacts.filter(x => x.available)) {
      const isSameAsMain = proj && a.file === artifactFile;
      if (isSameAsMain && !a.newer) continue;

      const isDebug = a.label.toLowerCase().includes('debug');
      const cls     = 'btn-artifact' + (isDebug ? ' btn-artifact-debug' : '');
      const size    = a.size ? `<span class="artifact-size">${formatSize(a.size)}</span>` : '';
      const time    = a.mtime ? `<div class="artifact-time">${relativeTime(a.mtime)}</div>` : '';
      items.push(
        `<div class="artifact-item">` +
        `<a class="${cls}" href="${esc(selectedId)}/${esc(a.file)}">â¬‡ ${esc(a.label)} ${size}<span class="badge-latest">Latest</span></a>` +
        `${time}</div>`
      );
    }
  }

  section.innerHTML = items.length > 0 ? `<div class="artifacts-row">${items.join('')}</div>` : '';
}

async function fetchArtifacts() {
  if (!selectedId) return;
  try {
    const res = await fetch(`/api/scan/${selectedId}?t=` + Date.now());
    if (!res.ok) return;
    renderArtifacts(await res.json());
  } catch (e) {
    renderArtifacts(null);
  }
}

async function triggerBuild() {
  if (!selectedId) return;
  const btn = document.getElementById('btn-build');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-sm"></span> Buildingâ€¦';
  try {
    const res = await fetch(`/api/build/${selectedId}`, { method: 'POST' });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert('Build trigger failed: ' + (err.error || res.status));
      btn.disabled = false;
      btn.innerHTML = 'â–¶ Build';
    }
    // Success: status polling will pick up the "building" state shortly
  } catch (e) {
    alert('Build trigger failed: ' + e.message);
    btn.disabled = false;
    btn.innerHTML = 'â–¶ Build';
  }
}

function toggleLog() {
  const body     = document.getElementById('log-body');
  const chevron  = document.getElementById('log-chevron');
  const isOpen   = body.style.display !== 'none';
  body.style.display = isOpen ? 'none' : 'block';
  chevron.className  = 'log-chevron' + (isOpen ? '' : ' open');
  if (!isOpen) body.scrollTop = body.scrollHeight;
}

// â”€â”€ Bootstrap â”€â”€
fetchProjects();
setInterval(fetchProjects, 15000);
setInterval(fetchStatus, 3000);
setInterval(fetchHistory, 10000);
setInterval(fetchArtifacts, 30000);

// Handle browser back/forward and mobile back gesture
window.addEventListener('hashchange', () => {
  const id = window.location.hash.slice(1);
  if (!id) {
    setMobileView(false);
    return;
  }
  if (id !== selectedId) {
    const proj = projects.find(p => p.id === id);
    if (proj) selectProject(id);
  }
});

// Reapply layout class when resizing between mobile/desktop
window.addEventListener('resize', () => setMobileView(!!selectedId));
</script>
</body>
</html>
