<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>serve_app</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f1117;
    color: #e1e4e8;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* â”€â”€ Sidebar â”€â”€ */
  #sidebar {
    width: 220px;
    flex-shrink: 0;
    background: #161b22;
    border-right: 1px solid #21262d;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #project-list {
    flex: 1;
    overflow-y: auto;
  }
  #sidebar-header {
    padding: 18px 16px 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #8b949e;
    border-bottom: 1px solid #21262d;
  }
  .project-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #21262d;
    transition: background 0.15s;
    text-decoration: none;
    color: inherit;
  }
  .project-item:hover { background: #1c2128; }
  .project-item.active { background: #1f2d3d; border-left: 3px solid #58a6ff; padding-left: 13px; }
  .project-item-info { flex: 1; min-width: 0; }
  .project-item-name {
    font-size: 13px;
    font-weight: 600;
    color: #c9d1d9;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .project-item-meta {
    font-size: 11px;
    color: #6e7681;
    margin-top: 2px;
  }
  .project-item-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot-ready    { background: #3fb950; }
  .dot-building { background: #f0c040; }
  .dot-failed   { background: #f85149; }
  .dot-unknown  { background: #484f58; }

  /* â”€â”€ Main panel â”€â”€ */
  #main {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
    min-width: 0;
  }

  #empty-state {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6e7681;
    font-size: 15px;
    text-align: center;
  }

  /* â”€â”€ Project detail â”€â”€ */
  #detail { display: none; }
  #detail-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 28px;
  }
  #detail-title {
    font-size: 22px;
    font-weight: 700;
    color: #e1e4e8;
  }
  #detail-subtitle {
    font-size: 13px;
    color: #8b949e;
    margin-top: 2px;
  }

  /* Status badge */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
  }
  .badge-ready    { background: #0f2d1a; color: #3fb950; }
  .badge-building { background: #2d2200; color: #f0c040; }
  .badge-failed   { background: #2d0000; color: #f85149; }
  .badge-unknown  { background: #21262d; color: #8b949e; }

  /* Spinner for building */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner-sm {
    width: 10px;
    height: 10px;
    border: 2px solid #4a3900;
    border-top-color: #f0c040;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
  }

  /* Downloads section */
  #downloads-section {
    margin-bottom: 24px;
  }
  .artifacts-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .artifact-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .btn-artifact {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #238636;
    color: #fff;
    text-decoration: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .btn-artifact:hover { background: #2ea043; }
  .btn-artifact-debug { background: #1f6feb; }
  .btn-artifact-debug:hover { background: #388bfd; }
  .artifact-size { font-size: 12px; opacity: 0.75; font-weight: 400; }
  .artifact-time { font-size: 11px; color: #6e7681; padding-left: 2px; }
  .badge-local {
    font-size: 10px;
    font-weight: 700;
    background: #f0c040;
    color: #1a1200;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.04em;
  }
  .badge-stable {
    font-size: 10px;
    font-weight: 700;
    background: rgba(255,255,255,0.18);
    color: #fff;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.04em;
  }
  .badge-latest {
    font-size: 10px;
    font-weight: 700;
    background: #e06c00;
    color: #fff;
    padding: 2px 6px;
    border-radius: 8px;
    letter-spacing: 0.04em;
  }

  /* Build button */
  #btn-build {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: 1px solid #30363d;
    color: #c9d1d9;
    padding: 9px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }
  #btn-build:hover:not(:disabled) { background: #21262d; border-color: #8b949e; }
  #btn-build:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Info grid */
  .info-grid {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 8px 16px;
    font-size: 13px;
    background: #161b22;
    border: 1px solid #21262d;
    border-radius: 10px;
    padding: 18px 20px;
    margin-bottom: 24px;
  }
  .info-grid .label {
    font-weight: 600;
    color: #8b949e;
  }
  .info-grid .value {
    color: #c9d1d9;
    word-break: break-word;
  }
  .info-grid .mono {
    font-family: 'SFMono-Regular', Consolas, monospace;
    color: #58a6ff;
  }

  /* Build log */
  .log-block {
    margin-bottom: 24px;
    border: 1px solid #21262d;
    border-radius: 10px;
    overflow: hidden;
  }
  .log-block.error { border-color: rgba(248,81,73,0.35); }

  .log-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 14px;
    background: #161b22;
    cursor: pointer;
    user-select: none;
  }
  .log-block.error .log-header { background: #1a0a0a; }

  .log-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
  }
  .log-block.error .log-header-left { color: #f85149; }
  .log-block:not(.error) .log-header-left { color: #8b949e; }

  .log-chevron {
    font-size: 10px;
    color: #6e7681;
    transition: transform 0.15s;
  }
  .log-chevron.open { transform: rotate(180deg); }

  .log-body {
    background: #0d1117;
    padding: 12px 14px;
    font-family: 'SFMono-Regular', Consolas, monospace;
    font-size: 11.5px;
    line-height: 1.6;
    color: #c9d1d9;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 380px;
    overflow-y: auto;
    border-top: 1px solid #21262d;
  }
  .log-block.error .log-body { color: #f0a0a0; }

  /* Build history */
  .section-title {
    font-size: 14px;
    font-weight: 600;
    color: #8b949e;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 12px;
  }
  .history-list {
    background: #161b22;
    border: 1px solid #21262d;
    border-radius: 10px;
    overflow: hidden;
  }
  .history-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    border-bottom: 1px solid #21262d;
    font-size: 12px;
  }
  .history-item:last-child { border-bottom: none; }
  .history-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .history-commit {
    font-family: 'SFMono-Regular', Consolas, monospace;
    color: #58a6ff;
    flex-shrink: 0;
    width: 56px;
  }
  .history-msg {
    flex: 1;
    color: #c9d1d9;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .history-branch {
    color: #8b949e;
    flex-shrink: 0;
    font-size: 11px;
  }
  .history-time {
    color: #6e7681;
    flex-shrink: 0;
    width: 56px;
    text-align: right;
  }

  /* Help button */
  #btn-help {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    margin-top: auto;
    border-top: 1px solid #21262d;
    background: none;
    border-left: none;
    border-right: none;
    border-bottom: none;
    color: #6e7681;
    font-size: 12px;
    cursor: pointer;
    text-align: left;
    width: 100%;
    transition: color 0.15s, background 0.15s;
  }
  #btn-help:hover { color: #c9d1d9; background: #1c2128; }

  /* Help modal */
  #help-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  #help-overlay.open { display: flex; }
  #help-modal {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 14px;
    width: 100%;
    max-width: 680px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #help-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 22px;
    border-bottom: 1px solid #21262d;
    flex-shrink: 0;
  }
  #help-modal-header h2 {
    font-size: 16px;
    font-weight: 700;
    color: #e1e4e8;
  }
  #btn-help-close {
    background: none;
    border: none;
    color: #6e7681;
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    padding: 0 4px;
  }
  #btn-help-close:hover { color: #c9d1d9; }
  #help-modal-body {
    overflow-y: auto;
    padding: 22px 24px;
    font-size: 13px;
    line-height: 1.7;
    color: #c9d1d9;
  }
  .help-section { margin-bottom: 28px; }
  .help-section:last-child { margin-bottom: 0; }
  .help-section h3 {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #58a6ff;
    margin-bottom: 10px;
  }
  .help-section p { margin-bottom: 8px; color: #8b949e; }
  .help-section p:last-child { margin-bottom: 0; }
  .help-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    margin-top: 4px;
  }
  .help-table th {
    text-align: left;
    padding: 6px 10px;
    color: #8b949e;
    font-weight: 600;
    border-bottom: 1px solid #21262d;
  }
  .help-table td {
    padding: 7px 10px;
    border-bottom: 1px solid #161b22;
    vertical-align: top;
  }
  .help-table tr:last-child td { border-bottom: none; }
  .help-table td:first-child {
    font-family: 'SFMono-Regular', Consolas, monospace;
    color: #79c0ff;
    white-space: nowrap;
    width: 1%;
  }
  .help-code {
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: 8px;
    padding: 14px 16px;
    font-family: 'SFMono-Regular', Consolas, monospace;
    font-size: 11.5px;
    line-height: 1.6;
    color: #c9d1d9;
    white-space: pre;
    overflow-x: auto;
    margin-top: 8px;
  }
  .help-badge-row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 6px;
  }
  .help-badge-row .badge-demo {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 8px;
  }
  .bd-stable { background: rgba(255,255,255,0.18); color: #fff; }
  .bd-latest { background: #e06c00; color: #fff; }

  /* No projects empty state */
  .empty-sidebar {
    padding: 20px 16px;
    font-size: 12px;
    color: #484f58;
    line-height: 1.6;
  }

  /* â”€â”€ Mobile: master-detail navigation â”€â”€ */
  #btn-back {
    display: none;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    color: #58a6ff;
    font-size: 15px;
    cursor: pointer;
    padding: 0;
    margin-bottom: 20px;
  }

  @media (max-width: 640px) {
    body { overflow: auto; }

    #sidebar {
      width: 100%;
      height: 100vh;
      border-right: none;
      border-bottom: 1px solid #21262d;
    }

    #main {
      display: none;
      width: 100%;
      padding: 20px 16px;
      min-height: 100vh;
    }

    /* list view: sidebar visible, detail hidden */
    body.mobile-list #sidebar  { display: flex; }
    body.mobile-list #main     { display: none; }

    /* detail view: sidebar hidden, detail visible */
    body.mobile-detail #sidebar { display: none; }
    body.mobile-detail #main    { display: block; }

    #btn-back { display: flex; }

    #detail-header { flex-wrap: wrap; gap: 10px; }
    .artifacts-row { flex-direction: column; }
    .btn-artifact { justify-content: center; }

    .history-branch { display: none; }
  }
</style>
</head>
<body>

<nav id="sidebar">
  <div id="sidebar-header">Projects</div>
  <div id="project-list">
    <div class="empty-sidebar">No projects registered yet.</div>
  </div>
  <button id="btn-help" onclick="openHelp()">? Help</button>
</nav>

<main id="main">
  <button id="btn-back" onclick="goBack()">&#8592; Projects</button>
  <div id="empty-state">
    <div>
      <div style="font-size:32px;margin-bottom:12px;">ğŸ“¦</div>
      <div>Select a project from the sidebar</div>
    </div>
  </div>
  <div id="detail">
    <div id="detail-header">
      <div>
        <div id="detail-title"></div>
        <div id="detail-subtitle"></div>
      </div>
      <div id="status-badge" class="status-badge badge-unknown"></div>
      <button id="btn-build" onclick="triggerBuild()">â–¶ Build</button>
    </div>
    <div id="info-section" class="info-grid"></div>
    <div id="downloads-section"></div>
    <div id="log-section" style="display:none">
      <div id="log-block" class="log-block error">
        <div class="log-header" onclick="toggleLog()">
          <div class="log-header-left">
            <span id="log-label">Build Output</span>
          </div>
          <span id="log-chevron" class="log-chevron open">â–¼</span>
        </div>
        <div id="log-body" class="log-body"></div>
      </div>
    </div>
    <div class="section-title">Build History</div>
    <div id="history-section" class="history-list" style="display:none"></div>
  </div>
</main>

<script>
// â”€â”€ State â”€â”€
let projects = [];
let selectedId = null;
let statusData = null;
let historyData = [];

// â”€â”€ Utilities â”€â”€
function esc(s) {
  const d = document.createElement('div');
  d.textContent = String(s || '');
  return d.innerHTML;
}

function relativeTime(ts) {
  if (!ts) return '';
  const diff = Date.now() - new Date(ts).getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  return new Date(ts).toLocaleDateString();
}

function formatTime(ts) {
  if (!ts) return '-';
  return new Date(ts).toLocaleString();
}

function formatSize(bytes) {
  if (!bytes || bytes === 0) return '';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function dotClass(status) {
  return { ready: 'dot-ready', building: 'dot-building', failed: 'dot-failed' }[status] || 'dot-unknown';
}

// â”€â”€ Sidebar rendering â”€â”€
function renderSidebar() {
  const listEl = document.getElementById('project-list');
  if (!projects.length) {
    listEl.innerHTML = '<div class="empty-sidebar">No projects registered yet.</div>';
    return;
  }
  listEl.innerHTML = projects.map(p => {
    const active = p.id === selectedId ? ' active' : '';
    const dot = dotClass(p.status);
    const time = relativeTime(p.lastBuildTime);
    return `<a class="project-item${active}" href="#${esc(p.id)}" onclick="selectProject('${esc(p.id)}');return false;">
      <div class="project-item-info">
        <div class="project-item-name">${esc(p.name)}</div>
        <div class="project-item-meta">${time || 'no builds'}</div>
      </div>
      <div class="project-item-dot ${dot}"></div>
    </a>`;
  }).join('');
}

// â”€â”€ Detail panel rendering â”€â”€
function renderDetail() {
  if (!selectedId) {
    document.getElementById('empty-state').style.display = 'flex';
    document.getElementById('detail').style.display = 'none';
    return;
  }

  const proj = projects.find(p => p.id === selectedId);
  if (!proj) return;

  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('detail').style.display = 'block';

  document.getElementById('detail-title').textContent = proj.name;

  const data = statusData;
  const status = data ? data.status : 'unknown';

  // Status badge
  const badgeEl = document.getElementById('status-badge');
  const badgeMap = {
    ready:    ['badge-ready',    '<span class="dot-ready" style="width:8px;height:8px;border-radius:50%;background:#3fb950;display:inline-block"></span> Ready'],
    building: ['badge-building', '<span class="spinner-sm"></span> Buildingâ€¦'],
    failed:   ['badge-failed',   '<span style="color:#f85149">âœ•</span> Failed'],
    unknown:  ['badge-unknown',  'â€” Unknown'],
  };
  const [cls, html] = badgeMap[status] || badgeMap.unknown;
  badgeEl.className = 'status-badge ' + cls;
  badgeEl.innerHTML = html;

  // Build button: disabled while building
  const buildBtn = document.getElementById('btn-build');
  buildBtn.disabled = (status === 'building');
  buildBtn.innerHTML = status === 'building' ? '<span class="spinner-sm"></span> Buildingâ€¦' : 'â–¶ Build';

  // Detail subtitle: branch@commit
  if (data && data.branch && data.commit) {
    document.getElementById('detail-subtitle').textContent = `${data.branch} @ ${data.commit}`;
  } else {
    document.getElementById('detail-subtitle').textContent = '';
  }

  // Info grid
  let info = '';
  if (data) {
    if (data.branch)    info += `<span class="label">Branch</span><span class="value">${esc(data.branch)}</span>`;
    if (data.commit)    info += `<span class="label">Commit</span><span class="value mono">${esc(data.commit)}</span>`;
    if (data.message)   info += `<span class="label">Message</span><span class="value">${esc(data.message)}</span>`;
    if (data.timestamp) info += `<span class="label">Built</span><span class="value">${formatTime(data.timestamp)}</span>`;
  }
  const infoEl = document.getElementById('info-section');
  if (info) {
    infoEl.innerHTML = info;
    infoEl.style.display = 'grid';
  } else {
    infoEl.style.display = 'none';
  }

  // Log panel: always show, style and expand based on status
  const logSection = document.getElementById('log-section');
  const logBlock   = document.getElementById('log-block');
  const logLabel   = document.getElementById('log-label');
  const logChevron = document.getElementById('log-chevron');
  const logBody    = document.getElementById('log-body');
  logSection.style.display = 'block';
  if (status === 'failed') {
    logBlock.className = 'log-block error';
    logBody.style.display = 'block';
    logChevron.className = 'log-chevron open';
  } else if (status === 'building') {
    logBlock.className = 'log-block';
    logBody.style.display = 'block';
    logChevron.className = 'log-chevron open';
  } else {
    // ready / unknown: collapsed by default
    logBlock.className = 'log-block';
    logBody.style.display = 'none';
    logChevron.className = 'log-chevron';
  }

  // History
  renderHistory();
}

function renderHistory() {
  const el = document.getElementById('history-section');
  if (!historyData || historyData.length === 0) {
    el.style.display = 'none';
    return;
  }
  el.style.display = 'block';
  el.innerHTML = historyData.map(item => {
    const dot = dotClass(item.status);
    return `<div class="history-item">
      <span class="history-dot ${dot}"></span>
      <span class="history-commit">${esc(item.commit || '')}</span>
      <span class="history-msg">${esc(item.message || '')}</span>
      <span class="history-branch">${esc(item.branch || '')}</span>
      <span class="history-time">${relativeTime(item.timestamp)}</span>
    </div>`;
  }).join('');
}

// â”€â”€ Mobile navigation â”€â”€
function isMobile() { return window.innerWidth <= 640; }

function goBack() {
  document.body.className = 'mobile-list';
  window.location.hash = '';
}

function setMobileView(hasSelection) {
  if (isMobile()) {
    document.body.className = hasSelection ? 'mobile-detail' : 'mobile-list';
  } else {
    document.body.className = '';
  }
}

// â”€â”€ Project selection â”€â”€
function selectProject(id) {
  stopLogLive();
  selectedId = id;
  statusData = null;
  historyData = [];
  document.getElementById('log-body').textContent = '';
  window.location.hash = id;
  setMobileView(true);
  renderSidebar();
  renderDetail();
  fetchStatus();
  fetchHistory();
  fetchLog();
  fetchArtifacts();
}

// â”€â”€ Polling â”€â”€
async function fetchProjects() {
  try {
    const res = await fetch('projects.json?t=' + Date.now());
    if (!res.ok) return;
    const data = await res.json();
    // Sort by lastBuildTime descending, unknown last
    data.sort((a, b) => {
      if (!a.lastBuildTime && !b.lastBuildTime) return 0;
      if (!a.lastBuildTime) return 1;
      if (!b.lastBuildTime) return -1;
      return new Date(b.lastBuildTime) - new Date(a.lastBuildTime);
    });
    projects = data;

    // Auto-select first project on initial load
    if (!selectedId && projects.length > 0) {
      const hashId = window.location.hash.slice(1);
      // On mobile, don't auto-select â€” show the list first
      if (isMobile() && !hashId) {
        setMobileView(false);
        renderSidebar();
      } else {
        const target = projects.find(p => p.id === hashId) || projects[0];
        selectProject(target.id);
      }
    } else {
      renderSidebar();
    }
  } catch (e) {}
}

async function fetchStatus() {
  if (!selectedId) return;
  try {
    const res = await fetch(`${selectedId}/build-status.json?t=` + Date.now());
    if (!res.ok) return;
    const prev = statusData ? statusData.status : null;
    statusData = await res.json();
    renderDetail();
    const cur = statusData.status;
    if (cur === 'building') {
      fetchLog();
      startLogLive();
    } else {
      stopLogLive();
      if (cur !== prev) fetchLog(); // refresh once on status change
    }
  } catch (e) {}
}

async function fetchHistory() {
  if (!selectedId) return;
  try {
    const res = await fetch(`${selectedId}/build-history.json?t=` + Date.now());
    if (!res.ok) return;
    historyData = await res.json();
    renderHistory();
  } catch (e) {}
}

async function fetchLog() {
  if (!selectedId) return;
  try {
    const res = await fetch(`${selectedId}/build.log?t=` + Date.now());
    if (!res.ok) return;
    const text = await res.text();
    const body = document.getElementById('log-body');
    if (body.style.display === 'none') return; // collapsed â€” don't update
    const atBottom = body.scrollHeight - body.scrollTop - body.clientHeight < 40;
    body.textContent = text;
    if (atBottom) body.scrollTop = body.scrollHeight;
  } catch (e) {}
}

let logLiveInterval = null;

function startLogLive() {
  if (logLiveInterval) return;
  logLiveInterval = setInterval(fetchLog, 2000);
}

function stopLogLive() {
  if (logLiveInterval) { clearInterval(logLiveInterval); logLiveInterval = null; }
}

// â”€â”€ Artifacts â”€â”€
function renderArtifacts(artifacts) {
  const section = document.getElementById('downloads-section');
  const proj = projects.find(p => p.id === selectedId);
  const data = statusData;

  let items = [];

  // Always show the serve_app-built (Stable) download when status is ready
  const artifactFile = proj && (proj.artifactFile || proj.apkFile);
  const artifactSize = data && (data.artifactSize ?? data.apkSize);
  if (artifactFile && data && data.status === 'ready') {
    const size = artifactSize ? ` <span class="artifact-size">${formatSize(artifactSize)}</span>` : '';
    items.push(
      `<div class="artifact-item">` +
      `<a class="btn-artifact" href="${esc(selectedId)}/${esc(artifactFile)}">â¬‡ Download${size} <span class="badge-stable">Stable</span></a>` +
      `</div>`
    );
  }

  // Additionally show local builds from watchArtifacts (Latest)
  // - same file as apkFile (e.g. Debug that serve_app also builds): only if newer=true
  // - different file (e.g. Release that serve_app never builds): show whenever available
  if (artifacts && artifacts.length > 0) {
    for (const a of artifacts.filter(x => x.available)) {
      const isSameAsMain = proj && a.file === artifactFile;
      if (isSameAsMain && !a.newer) continue;

      const isDebug = a.label.toLowerCase().includes('debug');
      const cls     = 'btn-artifact' + (isDebug ? ' btn-artifact-debug' : '');
      const size    = a.size ? `<span class="artifact-size">${formatSize(a.size)}</span>` : '';
      const time    = a.mtime ? `<div class="artifact-time">${relativeTime(a.mtime)}</div>` : '';
      items.push(
        `<div class="artifact-item">` +
        `<a class="${cls}" href="${esc(selectedId)}/${esc(a.file)}">â¬‡ ${esc(a.label)} ${size}<span class="badge-latest">Latest</span></a>` +
        `${time}</div>`
      );
    }
  }

  section.innerHTML = items.length > 0 ? `<div class="artifacts-row">${items.join('')}</div>` : '';
}

async function fetchArtifacts() {
  if (!selectedId) return;
  try {
    const res = await fetch(`/api/scan/${selectedId}?t=` + Date.now());
    if (!res.ok) return;
    renderArtifacts(await res.json());
  } catch (e) {
    renderArtifacts(null);
  }
}

async function triggerBuild() {
  if (!selectedId) return;
  const btn = document.getElementById('btn-build');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-sm"></span> Buildingâ€¦';
  try {
    const res = await fetch(`/api/build/${selectedId}`, { method: 'POST' });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert('Build trigger failed: ' + (err.error || res.status));
      btn.disabled = false;
      btn.innerHTML = 'â–¶ Build';
    }
    // Success: status polling will pick up the "building" state shortly
  } catch (e) {
    alert('Build trigger failed: ' + e.message);
    btn.disabled = false;
    btn.innerHTML = 'â–¶ Build';
  }
}

function toggleLog() {
  const body     = document.getElementById('log-body');
  const chevron  = document.getElementById('log-chevron');
  const isOpen   = body.style.display !== 'none';
  body.style.display = isOpen ? 'none' : 'block';
  chevron.className  = 'log-chevron' + (isOpen ? '' : ' open');
  if (!isOpen) body.scrollTop = body.scrollHeight;
}

// â”€â”€ Bootstrap â”€â”€
fetchProjects();
setInterval(fetchProjects, 15000);
setInterval(fetchStatus, 3000);
setInterval(fetchHistory, 10000);
setInterval(fetchArtifacts, 30000);

// Handle browser back/forward and mobile back gesture
window.addEventListener('hashchange', () => {
  const id = window.location.hash.slice(1);
  if (!id) {
    setMobileView(false);
    return;
  }
  if (id !== selectedId) {
    const proj = projects.find(p => p.id === id);
    if (proj) selectProject(id);
  }
});

// Reapply layout class when resizing between mobile/desktop
window.addEventListener('resize', () => setMobileView(!!selectedId));

// â”€â”€ Help modal â”€â”€
function openHelp() {
  document.getElementById('help-overlay').classList.add('open');
}
function closeHelp() {
  document.getElementById('help-overlay').classList.remove('open');
}
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeHelp();
});
document.getElementById('help-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeHelp();
});
</script>

<!-- Help modal -->
<div id="help-overlay">
  <div id="help-modal">
    <div id="help-modal-header">
      <h2>serve_app ì‚¬ìš©ë²•</h2>
      <button id="btn-help-close" onclick="closeHelp()">âœ•</button>
    </div>
    <div id="help-modal-body">

      <div class="help-section">
        <h3>ê°œìš”</h3>
        <p>git commit ì‹œ ìë™ìœ¼ë¡œ ë¹Œë“œí•˜ê³ , ì´ í˜ì´ì§€ì—ì„œ ì•„í‹°íŒ©íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” ë¡œì»¬ CI/CD ì„œë²„ì…ë‹ˆë‹¤. Android, iOS, Flutter ë“± ì–´ë–¤ ë¹Œë“œ ì‹œìŠ¤í…œì´ë“  ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      </div>

      <div class="help-section">
        <h3>ìƒˆ í”„ë¡œì íŠ¸ ë“±ë¡</h3>
        <p>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— <code style="color:#79c0ff">.serve_app.json</code>ì„ ë§Œë“¤ê³  <code style="color:#79c0ff">register.sh</code>ë¥¼ í•œ ë²ˆ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤. ì´í›„ git commit ë§ˆë‹¤ ìë™ ë¹Œë“œë©ë‹ˆë‹¤.</p>
        <div class="help-code"># 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .serve_app.json ì¶”ê°€ (ì•„ë˜ ì„¤ì • í•­ëª© ì°¸ê³ )

# 2. ë“±ë¡ (git hook ìë™ ì„¤ì¹˜)
cd /path/to/my-app
~/Repos/serve_app/scripts/register.sh</div>
      </div>

      <div class="help-section">
        <h3>.serve_app.json ì„¤ì • í•­ëª©</h3>
        <table class="help-table">
          <tr><th>í•„ë“œ</th><th>ì„¤ëª…</th></tr>
          <tr><td>id</td><td>í”„ë¡œì íŠ¸ ì‹ë³„ì (ì˜ë¬¸ ì†Œë¬¸ìÂ·í•˜ì´í”ˆ). URLê³¼ ë””ë ‰í† ë¦¬ëª…ì— ì‚¬ìš©ë¨</td></tr>
          <tr><td>name</td><td>UIì— í‘œì‹œë  í”„ë¡œì íŠ¸ ì´ë¦„</td></tr>
          <tr><td>buildCommand</td><td>ë¹Œë“œ ëª…ë ¹ì–´. ì‰˜ì—ì„œ ê·¸ëŒ€ë¡œ ì‹¤í–‰ë¨ (ì˜ˆ: <code style="color:#79c0ff">./gradlew assembleDebug</code>)</td></tr>
          <tr><td>buildWorkingDir</td><td>ë¹Œë“œë¥¼ ì‹¤í–‰í•  ë””ë ‰í† ë¦¬. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ ê°€ëŠ¥</td></tr>
          <tr><td>artifactPath</td><td>ë¹Œë“œ ê²°ê³¼ë¬¼ ê²½ë¡œ. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê¸°ì¤€ ìƒëŒ€ê²½ë¡œ ê°€ëŠ¥</td></tr>
          <tr><td>artifactName</td><td>ì„œë¹™ë  íŒŒì¼ëª… (ì˜ˆ: <code style="color:#79c0ff">MyApp.apk</code>, <code style="color:#79c0ff">MyApp.ipa</code>)</td></tr>
          <tr><td>watchArtifacts</td><td>ë¡œì»¬ ë¹Œë“œ ê°ì§€ ëŒ€ìƒ ëª©ë¡ (ì„ íƒ, ì•„ë˜ ì°¸ê³ )</td></tr>
        </table>
        <div class="help-code">{
  "id": "my-app",
  "name": "My App",
  "buildCommand": "./gradlew assembleDebug",
  "buildWorkingDir": ".",
  "artifactPath": "app/build/outputs/apk/debug/app-debug.apk",
  "artifactName": "MyApp-debug.apk",
  "watchArtifacts": [
    { "label": "Debug",   "path": "app/build/outputs/apk/debug/app-debug.apk",   "file": "MyApp-debug.apk" },
    { "label": "Release", "path": "app/build/outputs/apk/release/app-release.apk","file": "MyApp-release.apk" }
  ]
}</div>
      </div>

      <div class="help-section">
        <h3>ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì¢…ë¥˜</h3>
        <p>í”„ë¡œì íŠ¸ ìƒì„¸ í™”ë©´ì—ì„œ ë‘ ì¢…ë¥˜ì˜ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì´ í‘œì‹œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="help-badge-row" style="margin-bottom:10px">
          <span class="badge-demo bd-stable">Stable</span>
          <span style="color:#8b949e;font-size:12px">â€” serve_appì´ git commit ê¸°ì¤€ìœ¼ë¡œ ë¹Œë“œí•œ ê³µì‹ ë¹Œë“œ. ë¹Œë“œ ìƒíƒœê°€ readyì¼ ë•Œ í•­ìƒ í‘œì‹œ.</span>
        </div>
        <div class="help-badge-row">
          <span class="badge-demo bd-latest">Latest</span>
          <span style="color:#8b949e;font-size:12px">â€” ì €ì¥ì†Œì—ì„œ ì§ì ‘ ë¹Œë“œí•œ ìµœì‹  ë¡œì»¬ ë¹Œë“œ. watchArtifacts ì„¤ì • ì‹œ ìë™ ê°ì§€.</span>
        </div>
        <p style="margin-top:10px">watchArtifactsì— ë“±ë¡ëœ íŒŒì¼ ì¤‘ <b style="color:#c9d1d9">artifactNameê³¼ ë‹¤ë¥¸ íŒŒì¼</b>(ì˜ˆ: Release)ì€ íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ í•­ìƒ í‘œì‹œë˜ê³ , <b style="color:#c9d1d9">ê°™ì€ íŒŒì¼</b>(ì˜ˆ: Debug)ì€ ë¡œì»¬ ë¹Œë“œê°€ Stableë³´ë‹¤ ìµœì‹ ì¼ ë•Œë§Œ ì¶”ê°€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>

      <div class="help-section">
        <h3>ìˆ˜ë™ ë¹Œë“œ</h3>
        <p>í”„ë¡œì íŠ¸ ìƒì„¸ ìš°ì¸¡ ìƒë‹¨ì˜ <b style="color:#c9d1d9">â–¶ Build</b> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ git commit ì—†ì´ë„ ì¦‰ì‹œ ë¹Œë“œë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¹Œë“œ ì¤‘ì—ëŠ” ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ê³  ì‹¤ì‹œê°„ ë¡œê·¸ê°€ ì—´ë¦½ë‹ˆë‹¤.</p>
        <p>CLIì—ì„œ ì§ì ‘ ì‹¤í–‰í•˜ë ¤ë©´:</p>
        <div class="help-code">~/Repos/serve_app/scripts/build.sh &lt;project-id&gt;</div>
      </div>

      <div class="help-section">
        <h3>ìƒˆ ë§¥ì— ì„¤ì¹˜</h3>
        <div class="help-code"># 1. serve_app í´ë¡  (ê²½ë¡œ ê³ ì • í•„ìˆ˜)
git clone &lt;repo-url&gt; ~/Repos/serve_app

# 2. ì´ˆê¸° ì„¤ì • (LaunchAgent ë“±ë¡ â†’ ë¡œê·¸ì¸ ì‹œ ìë™ ì‹œì‘)
~/Repos/serve_app/install.sh

# 3. í”„ë¡œì íŠ¸ í´ë¡  + ë“±ë¡
cd ~/Repos/my-app &amp;&amp; ~/Repos/serve_app/scripts/register.sh</div>
      </div>

      <div class="help-section">
        <h3>ì„œë²„ ê´€ë¦¬</h3>
        <div class="help-code"># ì„œë²„ ì¬ì‹œì‘
launchctl kickstart -k gui/$(id -u)/com.serve_app

# ì„œë²„ ì¤‘ì§€
launchctl bootout gui/$(id -u)/com.serve_app

# ë¹Œë“œ ë¡œê·¸ CLIë¡œ í™•ì¸
tail -f ~/Repos/serve_app/serve/&lt;id&gt;/build.log</div>
      </div>

    </div>
  </div>
</div>
</body>
</html>
